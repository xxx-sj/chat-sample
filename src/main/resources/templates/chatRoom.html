<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        .chat-box {
            display: flex;
            flex-direction: column;
            padding: 5px;
            margin-top: 10px;
        }

        .chat-message {
            color: white;
            width: auto;
            height: auto;
            padding: 5px;
        }

        .chat-right {
            text-align: right;
            background: #66CDAA;
            margin-left: auto;
        }

        .chat-left {
            background: #D9D9D9;
            margin-right: auto;
        }
    </style>

</head>
<body>
<div style="display: flex;">
    <section style="width: 30%;">
        <ul>
            <li><button onclick="enterRoom(1)">1</button></li>
            <li><button onclick="enterRoom(2)">2</button></li>
            <li><button onclick="enterRoom(3)">3</button></li>
        </ul>
        <div>
            <p>현재 접속중인 방은 <span id="currentRoomNumber"></span></p>
        </div>
    </section>
    <section style="width: 70%;">
        <div id="messages" style="border: 1px solid black; height: 90vh; display: flex; flex-direction: column; overflow: scroll;">
            message list
        </div>
        <div class="message" style="border: 1px solid black; height: 6vh; margin-top: 10px; display: flex;">
            <input id="name" style="width: 300px; height: 90%;"/>
            <input id="entityId" style="width: 100px; height: 90%" placeholder="entityId"/>
            <input id="message" style="width: 60%; height: 90%;" onkeydown="sendMessageWithEnter(event)"/>
            <button type="button" id="send" onclick="sendMessage()">전송</button>
        </div>
    </section>
</div>
</body>

<script src="https://cdn.jsdelivr.net/sockjs/1.0.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>


<script>
    let stompClient = null;
    let currentRoomId = null;
    let entityId = 1;
    let subscription = null; //현재 구독하고 있는 topic

    window.onload = () => {
        connect();
    }

    //websocket 연결
    function connect() {
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
        });
    }


    function enterRoom(roomId) {
        if (subscription) {
            subscription.unsubscribe();
        }
        currentRoomId = roomId;
        //unsubscribe
        //방들어갔을때 메시지는 얼마나 보여줄것인가?
        //채팅방 들어갔을때 메시지 보여주는거 .
        //Kakao 생각하시면 된다. 그 중간에 데이터를 어떻게 할 것인가. 싱크를 생각해야해요
        document.getElementById("currentRoomNumber").innerText = currentRoomId;
        subscription = stompClient.subscribe(`/sub/chats/rooms/${roomId}`, function (message) {
            console.log("subscribe", {message})
            showMessage(JSON.parse(message.body));
        });
    }

    function sendMessageWithEnter(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (e.isComposing) {
                return;
            }
            sendMessage();
        }
    }

    function sendMessage() {
        const message = document.getElementById("message");
        const messageInput = message.value;

        //공백을 보낼것인가? trim()없이 비교하면돼요
        if (messageInput.trim() === '') return;

        const name = document.getElementById("name").value;
        const sender = document.getElementById("entityId").value || entityId;

        console.log({name}, {currentRoomId}, {message})
        stompClient.send(`/pub/chats/rooms/${currentRoomId}`, {}, JSON.stringify({
            entityId: sender,
            name: name,
            roomId: currentRoomId,
            message: messageInput
            //메시지를 매번 저장해야할 때 데이터가 추가로 필요하다.
        }));

        message.value = "";

    }

    function showMessage(message) {
        const response = document.getElementById('messages');
        const textBox = document.createElement('div');
        const messageSpan = document.createElement("span");
        const nameSpan = document.createElement("span");

        textBox.appendChild(nameSpan);
        textBox.appendChild(messageSpan);

        textBox.classList.add("chat-box");

        if (message.entityId === entityId) {
            textBox.style.textAlign = "right";
            messageSpan.classList.add("chat-right");
        } else {
            messageSpan.classList.add("chat-left");
        }

        messageSpan.classList.add("chat-message");


        messageSpan.innerText = `${message.message}`;
        nameSpan.innerText = message.name;
        response.appendChild(textBox);

        setTimeout(() => {
            response.scrollTop = response.scrollHeight;
        }, 50);

    }

    //unsubscribe
    function unsubscribe() {
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
        }
    }
</script>
</html>